<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOJO TORNEIOS - Admin Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üü£</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-title { font-size: 2rem; color: #667eea; margin-bottom: 30px; font-weight: bold; }
        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }
        .login-input:focus { outline: none; border-color: #667eea; }
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .dashboard { display: none; }
        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .header h1 { color: white; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .nav-tab.active { background: rgba(255,255,255,0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-number { font-size: 3rem; color: #667eea; font-weight: bold; }
        .stat-label { color: #666; margin-top: 10px; }
        .card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .card-title { font-size: 1.5rem; color: #667eea; font-weight: bold; }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .btn-success { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .btn-sm { padding: 6px 12px; font-size: 0.9rem; }
        .search-bar { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 20px; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold; }
        tr:hover { background: #f5f5f5; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.5; }
        .pagination .page-info { color: white; font-weight: bold; padding: 0 15px; }
        .vip-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .vip-1 { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .vip-2 { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .vip-3 { background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; }
        .vip-4 { background: linear-gradient(135deg, #fa709a, #fee140); color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
        }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; color: #667eea; }
        .form-input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .ban-source {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        .ban-room { background: #ffa726; color: white; }
        .ban-admin { background: #ef5350; color: white; }
        .ban-auto { background: #ab47bc; color: white; }
        .log-item {
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .log-item:hover {
            background: rgba(255,255,255,0.7);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1 class="login-title">üü£ JOJO ADMIN</h1>
            <input type="password" id="loginPassword" class="login-input" placeholder="Senha do Admin">
            <button onclick="login()" class="login-btn">Entrar</button>
            <div id="loginError" class="alert alert-error" style="display: none;"></div>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div class="header">
            <h1>üü£ JOJO TORNEIOS - ADMIN üü£</h1>
            <button onclick="logout()" class="logout-btn">üö™ Sair</button>
        </div>

        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('overview')">üìä Vis√£o Geral</button>
                <button class="nav-tab" onclick="showTab('players')">üë• Jogadores</button>
                <button class="nav-tab" onclick="showTab('vips')">üíé VIPs</button>
                <button class="nav-tab" onclick="showTab('coins')">üü£ Purple Coins</button>
                <button class="nav-tab" onclick="showTab('stats')">üìä Stats GOATS</button>
                <button class="nav-tab" onclick="showTab('tracking')">üîç Rastreamento</button>
                <button class="nav-tab" onclick="showTab('bans')">üö´ Banimentos</button>
                <button class="nav-tab" onclick="showTab('history')">üìã Hist√≥rico</button>
                <button class="nav-tab" onclick="showTab('logs')">üìù Logs</button>
            </div>

            <!-- VIS√ÉO GERAL -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPlayers">-</div>
                        <div class="stat-label">Jogadores Registrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalLogins">-</div>
                        <div class="stat-label">Total de Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalBans">-</div>
                        <div class="stat-label">Jogadores Banidos</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚ö° A√ß√µes R√°pidas</div>
                        <button onclick="loadData()" class="btn">üîÑ Atualizar Dados</button>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button onclick="showTab('players')" class="btn">üë• Gerenciar Jogadores</button>
                        <button onclick="showTab('vips')" class="btn">üíé Gerenciar VIPs</button>
                        <button onclick="showTab('bans')" class="btn">üö´ Gerenciar Bans</button>
                        <button onclick="exportData()" class="btn">üì• Exportar Dados</button>
                    </div>
                </div>
            </div>

            <!-- JOGADORES -->
            <div id="players" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üë• Todos os Jogadores</div>
                        <button onclick="loadPlayers()" class="btn">üîÑ Atualizar</button>
                    </div>
                    
                    <input type="text" class="search-bar" placeholder="üîç Pesquisar por Discord ou Nick..." id="playersSearch" oninput="filterPlayers()">
                    
                    <table id="playersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Discord</th>
                                <th>Nick Haxball</th>
                                <th>Registro</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="playersTableBody"></tbody>
                    </table>
                    
                    <div class="pagination">
                        <button onclick="changePage('players', -1)" id="playersPrevBtn">‚Üê Anterior</button>
                        <span class="page-info" id="playersPageInfo">P√°gina 1</span>
                        <button onclick="changePage('players', 1)" id="playersNextBtn">Pr√≥xima ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- VIPS -->
            <div id="vips" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üíé Gerenciar VIPs</div>
                        <button onclick="showAddVipModal()" class="btn btn-success">‚ûï Adicionar VIP</button>
                    </div>
                    
                    <table id="vipsTable">
                        <thead>
                            <tr>
                                <th>Nick</th>
                                <th>N√≠vel VIP</th>
                                <th>Data In√≠cio</th>
                                <th>Data Fim</th>
                                <th>Tempo Restante</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="vipsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PURPLE COINS -->
            <div id="coins" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üü£ Gerenciar Purple Coins</div>
                        <button onclick="showAddCoinsModal()" class="btn btn-success">‚ûï Adicionar Moedas</button>
                    </div>
                    
                    <input type="text" class="search-bar" placeholder="üîç Pesquisar jogador..." id="coinsSearch" oninput="filterCoins()">
                    
                    <table id="coinsTable">
                        <thead>
                            <tr>
                                <th>Nick</th>
                                <th>Purple Coins üü£</th>
                                <th>√öltima Atualiza√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="coinsTableBody"></tbody>
                    </table>
                    
                    <div class="pagination">
                        <button onclick="changePage('coins', -1)" id="coinsPrevBtn">‚Üê Anterior</button>
                        <span class="page-info" id="coinsPageInfo">P√°gina 1</span>
                        <button onclick="changePage('coins', 1)" id="coinsNextBtn">Pr√≥xima ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- BANIMENTOS -->
            <div id="bans" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üö´ Jogadores Banidos</div>
                        <button onclick="loadBannedPlayers()" class="btn">üîÑ Atualizar</button>
                    </div>
                    
                    <input type="text" class="search-bar" placeholder="üîç Pesquisar banidos..." id="bansSearch" oninput="filterBans()">
                    
                    <table id="bansTable">
                        <thead>
                            <tr>
                                <th>Nick</th>
                                <th>Motivo</th>
                                <th>Banido Por</th>
                                <th>Origem</th>
                                <th>Data</th>
                                <th>Expira</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="bansTableBody"></tbody>
                    </table>
                    
                    <div class="pagination">
                        <button onclick="changePage('bans', -1)" id="bansPrevBtn">‚Üê Anterior</button>
                        <span class="page-info" id="bansPageInfo">P√°gina 1</span>
                        <button onclick="changePage('bans', 1)" id="bansNextBtn">Pr√≥xima ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- HIST√ìRICO -->
            <div id="history" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã Hist√≥rico de A√ß√µes</div>
                        <button onclick="loadPlayerHistory()" class="btn">üîÑ Atualizar</button>
                    </div>
                    <div id="historyContent"></div>
                </div>
            </div>

            <!-- LOGS -->
            <div id="logs" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìù Logs do Sistema</div>
                        <button onclick="loadSystemLogs()" class="btn">üîÑ Atualizar</button>
                    </div>
                    <div id="logsContent"></div>
                </div>
            </div>

            <!-- STATS GOATS -->
            <div id="stats" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Stats das Salas</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="roomFilter" onchange="loadMatchHistory()" class="form-control" style="width: 150px;">
                                <option value="">Todas Salas</option>
                                <option value="GOATS">üêê GOATS</option>
                                <option value="NOOBS">üÜï NOOBS</option>
                            </select>
                            <button onclick="loadMatchHistory()" class="btn">üîÑ Atualizar</button>
                            <button onclick="exportStats()" class="btn btn-success">üì• Baixar Stats (CSV)</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div style="font-size: 3rem;">üéÆ</div>
                            <div class="stat-number" id="totalMatches">0</div>
                            <div class="stat-label">Partidas Registradas</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 3rem;">‚öΩ</div>
                            <div class="stat-number" id="totalGoalsStats">0</div>
                            <div class="stat-label">Gols Totais</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 3rem;">üÖ∞Ô∏è</div>
                            <div class="stat-number" id="totalAssistsStats">0</div>
                            <div class="stat-label">Assist√™ncias Totais</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 3rem;">üß§</div>
                            <div class="stat-number" id="totalCSStats">0</div>
                            <div class="stat-label">Clean Sheets</div>
                        </div>
                    </div>

                    <h3 style="margin: 30px 0 15px 0; color: #667eea;">üìã √öltimas 100 Partidas</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Nick</th>
                                <th>Discord</th>
                                <th>üéÆ Sala</th>
                                <th>‚öΩ Gols</th>
                                <th>üÖ∞Ô∏è Assists</th>
                                <th>üß§ CS</th>
                                <th>‚ö†Ô∏è GC</th>
                                <th>Resultado</th>
                                <th>Pontos</th>
                            </tr>
                        </thead>
                        <tbody id="matchHistoryTableBody">
                            <tr><td colspan="10" style="text-align:center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- RASTREAMENTO -->
    <div id="tracking" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üîç Rastreamento de Logins</h2>
                <button onclick="loadRecentLogins()" class="btn">üîÑ Atualizar</button>
            </div>

            <!-- SE√á√ÉO DE BUSCA -->
            <div class="card" style="background: rgba(102, 126, 234, 0.1); margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üîé Buscar Jogadores</h3>
                <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label class="form-label">Digite o identificador:</label>
                        <input id="trackSearchInput" class="form-input" placeholder="Cole aqui o auth, IPv4 ou conn...">
                    </div>
                    <div style="min-width: 150px;">
                        <label class="form-label">Tipo de busca:</label>
                        <select id="trackSearchType" class="form-input">
                            <option value="auth">üîë Auth</option>
                            <option value="ipv4">üåê IPv4</option>
                            <option value="conn">üîó Conn</option>
                        </select>
                    </div>
                    <button class="btn" onclick="searchByIdentifier()" style="padding: 12px 24px;">
                        üîé Buscar Jogadores
                    </button>
                </div>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    üí° Cole aqui o auth, IPv4 ou conn de um jogador para encontrar todas as contas que usaram o mesmo identificador
                </p>
            </div>

            <!-- RESULTADOS DA BUSCA -->
            <div id="searchResults" style="margin-bottom: 30px;"></div>

            <!-- √öLTIMOS LOGINS -->
            <h3 style="margin: 20px 0 15px 0; color: #667eea;">üìã √öltimos Logins</h3>
            <table>
                <thead>
                    <tr>
                        <th>‚è∞ Hora</th>
                        <th>üë§ Nick</th>
                        <th>üîë Auth</th>
                        <th>üåê IPv4</th>
                        <th>üîó Conn</th>
                        <th>üéÆ Sala</th>
                        <th>‚öôÔ∏è A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="recentLoginsTableBody">
                    <tr><td colspan="7" class="no-data" style="text-align:center;">Carregando √∫ltimos logins...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL DETALHES DO JOGADOR -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePlayerModal()">&times;</span>
            <h2 id="playerModalTitle" style="color: #667eea; margin-bottom: 20px;"></h2>
            <div id="playerModalContent"></div>
        </div>
    </div>

    <!-- MODAL LOCALIZA√á√ÉO IP -->
    <div id="ipLocationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeIpLocationModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üåç Localiza√ß√£o do IP</h2>
            <div id="ipLocationContent" style="text-align: left;">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 2rem;">‚è≥</div>
                    <p>Carregando informa√ß√µes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADICIONAR VIP -->
    <div id="vipModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeVipModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üíé Adicionar VIP</h2>
            <div class="form-group">
                <label class="form-label">Nick do Jogador</label>
                <input type="text" id="vipNick" class="form-input" placeholder="Digite o nick">
            </div>
            <div class="form-group">
                <label class="form-label">N√≠vel VIP</label>
                <select id="vipLevel" class="form-input">
                    <option value="1">VIP 1 - jojo lover üíú</option>
                    <option value="2">VIP 2 - Vip üíé</option>
                    <option value="3">VIP 3 - Premium ‚ú®</option>
                    <option value="4">VIP 4 - Purple üü£</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Dura√ß√£o (dias)</label>
                <input type="number" id="vipDuration" class="form-input" placeholder="30" value="30">
            </div>
            <button onclick="addVip()" class="btn btn-success" style="width: 100%;">Adicionar VIP</button>
        </div>
    </div>

    <!-- MODAL ADICIONAR PURPLE COINS -->
    <div id="coinsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCoinsModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üü£ Adicionar Purple Coins</h2>
            <div class="form-group">
                <label class="form-label">Nick do Jogador</label>
                <input type="text" id="coinsNick" class="form-input" placeholder="Digite o nick">
            </div>
            <div class="form-group">
                <label class="form-label">Quantidade de Moedas</label>
                <input type="number" id="coinsAmount" class="form-input" placeholder="100" value="100">
            </div>
            <button onclick="addCoins()" class="btn btn-success" style="width: 100%;">Adicionar Moedas</button>
        </div>
    </div>

    <!-- MODAL DOAR VIP COM MOEDAS -->
    <div id="giftVipModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGiftVipModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üéÅ Doar VIP com Purple Coins</h2>
            <div class="form-group">
                <label class="form-label">Nick do Jogador (Origem das Moedas)</label>
                <input type="text" id="giftFromNick" class="form-input" placeholder="Quem vai doar">
            </div>
            <div class="form-group">
                <label class="form-label">Nick do Jogador (Quem vai receber VIP)</label>
                <input type="text" id="giftToNick" class="form-input" placeholder="Quem vai ganhar VIP">
            </div>
            <div class="form-group">
                <label class="form-label">N√≠vel VIP</label>
                <select id="giftVipLevel" class="form-input">
                    <option value="1">VIP 1 - jojo lover üíú (500 moedas - 7 dias)</option>
                    <option value="2">VIP 2 - Vip üíé (1500 moedas - 15 dias)</option>
                    <option value="3">VIP 3 - Premium ‚ú® (3000 moedas - 30 dias)</option>
                    <option value="4">VIP 4 - Purple üü£ (6000 moedas - 60 dias)</option>
                </select>
            </div>
            <button onclick="giftVip()" class="btn btn-success" style="width: 100%;">üéÅ Confirmar Doa√ß√£o</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://jojotorneios-qhjm.onrender.com';
        let playersData = [];
        let bannedData = [];
        let vipsData = [];
        let coinsData = [];
    let recentLoginsCache = {}; // cache por id para copiar valores completos
        
        // Pagina√ß√£o
        let currentPage = { players: 1, bans: 1, coins: 1 };
        let itemsPerPage = 20;

        // LOGIN
        async function login() {
            const password = document.getElementById('loginPassword').value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin_login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    loadData();
                } else {
                    document.getElementById('loginError').textContent = '‚ùå Senha incorreta!';
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                document.getElementById('loginError').textContent = '‚ùå Erro ao conectar!';
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginPassword').value = '';
        }

        // NAVEGA√á√ÉO
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Encontrar e ativar o bot√£o correto
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach(btn => {
                if (btn.textContent.includes(tabName === 'overview' ? 'Vis√£o Geral' : 
                                            tabName === 'players' ? 'Jogadores' : 
                                            tabName === 'vips' ? 'VIPs' : 
                                            tabName === 'bans' ? 'Banimentos' : 
                                            tabName === 'tracking' ? 'Rastreamento' :
                                            tabName === 'history' ? 'Hist√≥rico' : 'Logs')) {
                    btn.classList.add('active');
                }
            });
            
            if (tabName === 'players') loadPlayers();
            if (tabName === 'vips') loadVips();
            if (tabName === 'coins') loadCoins();
            if (tabName === 'stats') loadMatchHistory();
            if (tabName === 'tracking') loadRecentLogins();
            if (tabName === 'bans') loadBannedPlayers();
            if (tabName === 'history') loadPlayerHistory();
            if (tabName === 'logs') loadSystemLogs();
        }

        // CARREGAR DADOS
        async function loadData() {
            try {
                const statsRes = await fetch(`${API_BASE_URL}/api/stats`);
                const stats = await statsRes.json();
                console.log('Stats recebidas:', stats); // Debug
                document.getElementById('totalPlayers').textContent = stats.total_players || 0;
                document.getElementById('totalLogins').textContent = stats.total_logins || 0;
                document.getElementById('totalBans').textContent = stats.total_bans || 0;
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
                document.getElementById('totalPlayers').textContent = '0';
                document.getElementById('totalLogins').textContent = '0';
                document.getElementById('totalBans').textContent = '0';
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/players`);
                const data = await response.json();
                console.log('Jogadores recebidos:', data); // Debug
                playersData = data.players || [];
                console.log('Total de jogadores:', playersData.length); // Debug
                renderPlayers();
            } catch (error) {
                console.error('Erro ao carregar jogadores:', error);
                playersData = [];
                renderPlayers();
            }
        }

        function renderPlayers() {
            const tbody = document.getElementById('playersTableBody');
            const searchTerm = document.getElementById('playersSearch').value.toLowerCase();
            
            let filtered = playersData.filter(p => 
                (p.discord_username?.toLowerCase() || '').includes(searchTerm) ||
                (p.haxball_nick?.toLowerCase() || '').includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Nenhum jogador encontrado</td></tr>';
                document.getElementById('playersPageInfo').textContent = 'P√°gina 0 de 0';
                document.getElementById('playersPrevBtn').disabled = true;
                document.getElementById('playersNextBtn').disabled = true;
                return;
            }
            
            const start = (currentPage.players - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = filtered.slice(start, end);
            
            tbody.innerHTML = paginated.map((player, i) => `
                <tr>
                    <td>${start + i + 1}</td>
                    <td>${player.discord_username || '-'}</td>
                    <td>${player.haxball_nick || '-'}</td>
                    <td>${player.created_at ? new Date(player.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                    <td><span class="badge ${player.banned ? 'badge-danger' : 'badge-success'}">${player.banned ? 'BANIDO' : 'ATIVO'}</span></td>
                    <td>
                        <button onclick="viewPlayerDetails('${player.haxball_nick}')" class="btn btn-sm">üìä Ver Stats</button>
                        <button onclick="viewLoginHistory('${player.haxball_nick}')" class="btn btn-sm">üîç Ver Login</button>
                        <button onclick="viewNickHistory('${player.haxball_nick}')" class="btn btn-sm">üìù Hist√≥rico Nomes</button>
                        <button onclick="showBanPlayer('${player.haxball_nick}')" class="btn btn-sm btn-danger">üö´ Banir</button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination('players', filtered.length);
        }

        async function loadBannedPlayers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/players`);
                const data = await response.json();
                console.log('Dados recebidos para bans:', data); // Debug
                bannedData = (data.players || []).filter(p => p.banned);
                console.log('Jogadores banidos:', bannedData.length); // Debug
                renderBannedPlayers();
            } catch (error) {
                console.error('Erro ao carregar banidos:', error);
                bannedData = [];
                renderBannedPlayers();
            }
        }

        function renderBannedPlayers() {
            const tbody = document.getElementById('bansTableBody');
            const searchTerm = document.getElementById('bansSearch')?.value.toLowerCase() || '';
            
            let filtered = bannedData.filter(p => 
                (p.haxball_nick?.toLowerCase() || '').includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">Nenhum jogador banido encontrado</td></tr>';
                document.getElementById('bansPageInfo').textContent = 'P√°gina 0 de 0';
                document.getElementById('bansPrevBtn').disabled = true;
                document.getElementById('bansNextBtn').disabled = true;
                return;
            }
            
            const start = (currentPage.bans - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = filtered.slice(start, end);
            
            tbody.innerHTML = paginated.map(player => `
                <tr>
                    <td>${player.haxball_nick || '-'}</td>
                    <td>${player.ban_reason || 'N√£o informado'}</td>
                    <td>${player.banned_by || 'Sistema'}</td>
                    <td><span class="ban-source ${player.banned_by === 'Sistema' ? 'ban-auto' : player.banned_by?.includes('Admin') ? 'ban-admin' : 'ban-room'}">${player.banned_by === 'Sistema' ? 'AUTO' : player.banned_by?.includes('Admin') ? 'ADMIN' : 'SALA'}</span></td>
                    <td>${player.banned_at ? new Date(player.banned_at).toLocaleString('pt-BR') : '-'}</td>
                    <td>${player.ban_expires ? new Date(player.ban_expires).toLocaleString('pt-BR') : 'Permanente'}</td>
                    <td>
                        <button onclick="unbanPlayer('${player.haxball_nick}')" class="btn btn-sm btn-success">‚úÖ Desbanir</button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination('bans', filtered.length);
        }

        async function loadVips() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/vips`);
                const data = await response.json();
                console.log('VIPs recebidos:', data);
                vipsData = data.vips || [];
                renderVips();
            } catch (error) {
                console.error('Erro ao carregar VIPs:', error);
                document.getElementById('vipsTableBody').innerHTML = '<tr><td colspan="6" class="no-data">Nenhum VIP ativo no momento</td></tr>';
            }
        }
        
        function renderVips() {
            const tbody = document.getElementById('vipsTableBody');
            
            if (vipsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Nenhum VIP ativo no momento</td></tr>';
                return;
            }
            
            tbody.innerHTML = vipsData.map(vip => {
                const now = new Date();
                const expires = new Date(vip.expires_at);
                const timeLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
                const vipClass = `vip-${vip.vip_level}`;
                const vipName = vip.vip_level === 1 ? 'jojo lover üíú' : 
                               vip.vip_level === 2 ? 'Vip üíé' : 
                               vip.vip_level === 3 ? 'Premium ‚ú®' : 'Purple üü£';
                
                return `
                    <tr>
                        <td>${vip.player_nick}</td>
                        <td><span class="vip-badge ${vipClass}">${vipName}</span></td>
                        <td>${new Date(vip.created_at).toLocaleDateString('pt-BR')}</td>
                        <td>${expires.toLocaleDateString('pt-BR')}</td>
                        <td>${timeLeft > 0 ? `${timeLeft} dias` : '<span class="badge badge-danger">EXPIRADO</span>'}</td>
                        <td>
                            <button onclick="removeVip('${vip.player_nick}')" class="btn btn-sm btn-danger">‚ùå Remover</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadPlayerHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/player_history?limit=50`);
                const data = await response.json();
                console.log('Hist√≥rico recebido:', data); // Debug
                const content = document.getElementById('historyContent');
                
                if (data.success && data.history && data.history.length > 0) {
                    content.innerHTML = data.history.map(h => {
                        const timestamp = h.created_at ? new Date(h.created_at).toLocaleString('pt-BR') : 'Data inv√°lida';
                        const actionType = h.action_type || 'A√á√ÉO';
                        const details = h.details || '';
                        const discord = h.discord_username || '';
                        
                        return `
                        <div class="log-item">
                            <div class="log-header">
                                <strong style="color: #667eea;">${actionType}</strong>
                                <span style="color: #999; font-size: 0.9rem;">${timestamp}</span>
                            </div>
                            <div style="color: #555;">
                                ${details}${discord ? ` - Discord: ${discord}` : ''}
                            </div>
                        </div>
                    `}).join('');
                } else {
                    content.innerHTML = '<div class="no-data">üìã Nenhum hist√≥rico de a√ß√µes encontrado</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                document.getElementById('historyContent').innerHTML = '<div class="no-data">‚ùå Erro ao carregar hist√≥rico</div>';
            }
        }

        async function loadSystemLogs() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/system_logs?limit=50`);
                const data = await response.json();
                console.log('Logs recebidos:', data); // Debug
                const content = document.getElementById('logsContent');
                
                if (data.success && data.logs && data.logs.length > 0) {
                    content.innerHTML = data.logs.map(log => {
                        const timestamp = log.created_at ? new Date(log.created_at).toLocaleString('pt-BR') : 'Data inv√°lida';
                        const logType = log.log_type || 'INFO';
                        const logColor = logType === 'error' ? '#ef5350' : logType === 'success' ? '#43e97b' : '#667eea';
                        const message = log.message || log.log_message || 'Sem mensagem';
                        
                        return `
                        <div class="log-item">
                            <div class="log-header">
                                <strong style="color: ${logColor};">${logType.toUpperCase()}</strong>
                                <span style="color: #999; font-size: 0.9rem;">${timestamp}</span>
                            </div>
                            <div style="color: #555;">${message}</div>
                        </div>
                    `}).join('');
                } else {
                    content.innerHTML = '<div class="no-data">üìù Nenhum log do sistema encontrado</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                document.getElementById('logsContent').innerHTML = '<div class="no-data">‚ùå Erro ao carregar logs</div>';
            }
        }

        // PAGINA√á√ÉO
        function changePage(type, direction) {
            currentPage[type] += direction;
            if (currentPage[type] < 1) currentPage[type] = 1;
            
            if (type === 'players') renderPlayers();
            if (type === 'bans') renderBannedPlayers();
            if (type === 'coins') renderCoins();
        }

        function updatePagination(type, totalItems) {
            const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
            const pageInfo = document.getElementById(`${type}PageInfo`);
            const prevBtn = document.getElementById(`${type}PrevBtn`);
            const nextBtn = document.getElementById(`${type}NextBtn`);
            
            if (pageInfo) pageInfo.textContent = `P√°gina ${currentPage[type]} de ${totalPages}`;
            if (prevBtn) prevBtn.disabled = currentPage[type] === 1;
            if (nextBtn) nextBtn.disabled = currentPage[type] >= totalPages || totalItems === 0;
        }

        function filterPlayers() {
            currentPage.players = 1;
            renderPlayers();
        }

        function filterBans() {
            currentPage.bans = 1;
            renderBannedPlayers();
        }

        // A√á√ïES
        async function viewPlayerDetails(nick) {
            // TODO: Implementar modal com stats completos
            alert(`Ver detalhes de ${nick} (em desenvolvimento)`);
        }

        async function showBanPlayer(nick) {
            if (confirm(`Deseja realmente banir ${nick}?`)) {
                try {
                    const reason = prompt('Motivo do ban:') || 'Banido por admin';
                    const response = await fetch(`${API_BASE_URL}/api/ban_player`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_name: nick, reason, banned_by: 'Admin Dashboard' })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Jogador banido com sucesso!');
                        loadPlayers();
                        loadData();
                    }
                } catch (error) {
                    alert('‚ùå Erro ao banir jogador!');
                }
            }
        }

        async function unbanPlayer(nick) {
            if (confirm(`Deseja desbanir ${nick}?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/unban_player`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_name: nick, unbanned_by: 'Admin Dashboard' })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Jogador desbanido com sucesso!');
                        loadBannedPlayers();
                        loadData();
                    }
                } catch (error) {
                    alert('‚ùå Erro ao desbanir jogador!');
                }
            }
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        function showAddVipModal() {
            document.getElementById('vipModal').style.display = 'block';
        }

        function closeVipModal() {
            document.getElementById('vipModal').style.display = 'none';
        }

        async function addVip() {
            const nick = document.getElementById('vipNick').value.trim();
            const level = parseInt(document.getElementById('vipLevel').value);
            const duration = parseInt(document.getElementById('vipDuration').value);
            
            if (!nick) {
                alert('‚ùå Digite o nick do jogador!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/add_vip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        player_nick: nick, 
                        vip_level: level, 
                        duration_days: duration,
                        added_by: 'Admin Dashboard'
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ VIP adicionado com sucesso!');
                    closeVipModal();
                    loadVips();
                    document.getElementById('vipNick').value = '';
                    document.getElementById('vipDuration').value = '30';
                } else {
                    alert('‚ùå ' + (data.message || 'Erro ao adicionar VIP'));
                }
            } catch (error) {
                console.error('Erro ao adicionar VIP:', error);
                alert('‚ùå Erro ao conectar com o servidor!');
            }
        }
        
        async function removeVip(nick) {
            if (confirm(`Deseja remover o VIP de ${nick}?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/remove_vip`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ player_nick: nick, removed_by: 'Admin Dashboard' })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úÖ VIP removido com sucesso!');
                        loadVips();
                    }
                } catch (error) {
                    alert('‚ùå Erro ao remover VIP!');
                }
            }
        }

        function exportData() {
            const data = {
                players: playersData,
                banned: bannedData,
                exported_at: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jojo_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // PURPLE COINS
        async function loadCoins() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/players`);
                const data = await response.json();
                coinsData = (data.players || []).map(p => ({
                    nick: p.haxball_nick,
                    coins: p.purple_coins || 0,
                    updated_at: p.coins_updated_at || p.created_at
                })).filter(p => p.coins > 0);
                renderCoins();
            } catch (error) {
                console.error('Erro ao carregar moedas:', error);
                coinsData = [];
                renderCoins();
            }
        }

        function renderCoins() {
            const tbody = document.getElementById('coinsTableBody');
            const searchTerm = document.getElementById('coinsSearch')?.value.toLowerCase() || '';
            
            let filtered = coinsData.filter(p => p.nick.toLowerCase().includes(searchTerm));
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">Nenhum jogador com Purple Coins</td></tr>';
                updatePagination('coins', 0);
                return;
            }
            
            const start = (currentPage.coins - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginated = filtered.slice(start, end);
            
            tbody.innerHTML = paginated.map(p => `
                <tr>
                    <td><strong>${p.nick}</strong></td>
                    <td><span style="font-size: 1.3rem; color: #667eea; font-weight: bold;">${p.coins} üü£</span></td>
                    <td>${new Date(p.updated_at).toLocaleString('pt-BR')}</td>
                    <td>
                        <button onclick="showGiftVipModal('${p.nick}')" class="btn btn-sm btn-success">üéÅ Doar VIP</button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination('coins', filtered.length);
        }

        function filterCoins() {
            currentPage.coins = 1;
            renderCoins();
        }

        function showAddCoinsModal() {
            document.getElementById('coinsModal').style.display = 'block';
        }

        function closeCoinsModal() {
            document.getElementById('coinsModal').style.display = 'none';
        }

        async function addCoins() {
            const nick = document.getElementById('coinsNick').value.trim();
            const amount = parseInt(document.getElementById('coinsAmount').value);
            
            if (!nick || !amount) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/add_coins`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_nick: nick, amount, added_by: 'Admin Dashboard' })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${amount} Purple Coins adicionados para ${nick}!`);
                    closeCoinsModal();
                    loadCoins();
                    document.getElementById('coinsNick').value = '';
                    document.getElementById('coinsAmount').value = '100';
                } else {
                    alert('‚ùå ' + (data.message || 'Erro ao adicionar moedas'));
                }
            } catch (error) {
                alert('‚ùå Erro ao conectar com o servidor!');
            }
        }

        function showGiftVipModal(fromNick = '') {
            document.getElementById('giftVipModal').style.display = 'block';
            if (fromNick) document.getElementById('giftFromNick').value = fromNick;
        }

        function closeGiftVipModal() {
            document.getElementById('giftVipModal').style.display = 'none';
        }

        async function giftVip() {
            const fromNick = document.getElementById('giftFromNick').value.trim();
            const toNick = document.getElementById('giftToNick').value.trim();
            const level = parseInt(document.getElementById('giftVipLevel').value);
            
            const costs = { 1: 500, 2: 1500, 3: 3000, 4: 6000 };
            const days = { 1: 7, 2: 15, 3: 30, 4: 60 };
            const cost = costs[level];
            const duration = days[level];
            
            if (!fromNick || !toNick) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }
            
            if (!confirm(`Confirmar doa√ß√£o de VIP n√≠vel ${level} para ${toNick}?\n\nCusto: ${cost} Purple Coins\nDura√ß√£o: ${duration} dias\n\nAs moedas ser√£o deduzidas de ${fromNick}.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/gift_vip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        from_nick: fromNick, 
                        to_nick: toNick, 
                        vip_level: level,
                        cost: cost,
                        duration_days: duration
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ VIP doado com sucesso!\n\n${fromNick} doou VIP n√≠vel ${level} para ${toNick}\nMoedas gastas: ${cost} üü£`);
                    closeGiftVipModal();
                    loadCoins();
                    loadVips();
                    document.getElementById('giftFromNick').value = '';
                    document.getElementById('giftToNick').value = '';
                } else {
                    alert('‚ùå ' + (data.message || 'Erro ao doar VIP'));
                }
            } catch (error) {
                alert('‚ùå Erro ao conectar com o servidor!');
            }
        }

        // STATS GOATS/NOOBS
        async function loadMatchHistory() {
            try {
                // Pegar filtro de sala selecionado
                const roomFilter = document.getElementById('roomFilter')?.value || '';
                const url = roomFilter 
                    ? `${API_BASE_URL}/api/get_match_history?limit=100&room=${encodeURIComponent(roomFilter)}`
                    : `${API_BASE_URL}/api/get_match_history?limit=100`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('matchHistoryTableBody');
                    tbody.innerHTML = '';
                    
                    let totalGoals = 0;
                    let totalAssists = 0;
                    let totalCS = 0;
                    
                    data.matches.forEach(match => {
                        totalGoals += match.goals;
                        totalAssists += match.assists;
                        totalCS += match.cs;
                        
                        const row = tbody.insertRow();
                        const date = new Date(match.date);
                        const dateStr = date.toLocaleString('pt-BR');
                        
                        // Emoji da sala
                        const roomEmoji = match.room === 'GOATS' ? 'üêê' : match.room === 'NOOBS' ? 'üÜï' : 'üéÆ';
                        
                        row.innerHTML = `
                            <td>${dateStr}</td>
                            <td><strong>${match.nick}</strong></td>
                            <td>${match.discord || '-'}</td>
                            <td style="text-align:center;">${roomEmoji} ${match.room}</td>
                            <td style="text-align:center;">${match.goals}</td>
                            <td style="text-align:center;">${match.assists}</td>
                            <td style="text-align:center;">${match.cs}</td>
                            <td style="text-align:center;">${match.owngoals}</td>
                            <td style="text-align:center;">${match.won ? '‚úÖ Vit√≥ria' : '‚ùå Derrota'}</td>
                            <td style="text-align:center;"><strong>${match.pontos}</strong></td>
                        `;
                    });
                    
                    document.getElementById('totalMatches').textContent = data.total;
                    document.getElementById('totalGoalsStats').textContent = totalGoals;
                    document.getElementById('totalAssistsStats').textContent = totalAssists;
                    document.getElementById('totalCSStats').textContent = totalCS;
                } else {
                    document.getElementById('matchHistoryTableBody').innerHTML = '<tr><td colspan="10" class="no-data">Nenhuma partida encontrada</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                document.getElementById('matchHistoryTableBody').innerHTML = '<tr><td colspan="10" class="no-data">‚ùå Erro ao carregar hist√≥rico</td></tr>';
            }
        }

        async function exportStats() {
            try {
                alert('‚è≥ Gerando arquivo CSV...');
                window.location.href = `${API_BASE_URL}/api/export_stats`;
                setTimeout(() => {
                    alert('‚úÖ Stats exportados com sucesso!');
                }, 1000);
            } catch (error) {
                console.error('Erro ao exportar stats:', error);
                alert('‚ùå Erro ao exportar stats');
            }
        }

        // RASTREAMENTO - Carrega √∫ltimos logins
        async function loadRecentLogins(limit = 100) {
            const tbody = document.getElementById('recentLoginsTableBody');
            try {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data" style="text-align:center;">Carregando...</td></tr>';
                const resp = await fetch(`${API_BASE_URL}/api/get_recent_logins?limit=${limit}`);
                const data = await resp.json();

                if (!data.success || !data.logins) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">Nenhum login encontrado</td></tr>';
                    return;
                }

                recentLoginsCache = {};
                tbody.innerHTML = '';

                data.logins.forEach(login => {
                    recentLoginsCache[login.id] = login; // guarda objeto completo

                    const tr = document.createElement('tr');
                    const time = new Date(login.login_time).toLocaleString('pt-BR');

                    tr.innerHTML = `
                        <td>${time}</td>
                        <td><strong>${login.haxball_nick}</strong></td>
                        <td style="font-family: monospace;">${login.auth || '-'}</td>
                        <td style="font-family: monospace;">${login.ipv4 || '-'}</td>
                        <td style="font-family: monospace;">${login.conn || '-'}</td>
                        <td>${login.room_name || '-'}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn btn-sm" onclick="copyFullAuth(${login.id})">üìã Copiar Auth</button>
                            <button class="btn btn-sm" onclick="copyIpv4('${login.ipv4}')">üìã IPv4</button>
                            <button class="btn btn-sm" onclick="viewIpLocation('${login.ipv4}')" title="Ver localiza√ß√£o do IP">üåç Localiza√ß√£o</button>
                            <button class="btn btn-sm" onclick="copyFullConn(${login.id})">üìã Copiar Conn</button>
                            <button class="btn btn-sm" onclick="viewLoginHistory('${login.haxball_nick}')">üëÅÔ∏è Ver</button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error('Erro ao carregar √∫ltimos logins:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">‚ùå Erro ao carregar √∫ltimos logins</td></tr>';
            }
        }

        function copyToClipboard(text) {
            if (!text) return alert('Valor vazio');
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert('‚úÖ Copiado para a √°rea de transfer√™ncia'))
                    .catch(() => alert('‚ùå Falha ao copiar'));
            } else {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                    alert('‚úÖ Copiado para a √°rea de transfer√™ncia');
                } catch (e) {
                    alert('‚ùå Falha ao copiar');
                }
                document.body.removeChild(ta);
            }
        }

        function copyFullAuth(id) {
            const entry = recentLoginsCache[id];
            if (!entry) return alert('Entrada n√£o encontrada');
            copyToClipboard(entry.auth_full || entry.auth || '');
        }

        function copyFullConn(id) {
            const entry = recentLoginsCache[id];
            if (!entry) return alert('Entrada n√£o encontrada');
            copyToClipboard(entry.conn_full || entry.conn || '');
        }

        function copyIpv4(ipv4) {
            if (!ipv4 || ipv4 === '-') return alert('IPv4 n√£o dispon√≠vel');
            copyToClipboard(ipv4);
        }

        async function viewIpLocation(ipv4) {
            if (!ipv4 || ipv4 === '-') return alert('IPv4 n√£o dispon√≠vel');
            
            const modal = document.getElementById('ipLocationModal');
            const content = document.getElementById('ipLocationContent');
            
            // Mostra o modal com loading
            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 2rem;">‚è≥</div>
                    <p>Carregando informa√ß√µes do IP <strong>${ipv4}</strong>...</p>
                </div>
            `;
            modal.style.display = 'block';
            
            try {
                // Usa a API gratuita ip-api.com para geolocaliza√ß√£o
                const response = await fetch(`http://ip-api.com/json/${ipv4}?lang=pt&fields=status,message,country,countryCode,region,regionName,city,zip,lat,lon,timezone,isp,org,as,query`);
                const data = await response.json();
                
                if (data.status === 'fail') {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 2rem; color: #d9534f;">‚ùå</div>
                            <p style="color: #d9534f;"><strong>Erro ao buscar localiza√ß√£o</strong></p>
                            <p>${data.message || 'IP inv√°lido ou n√£o encontrado'}</p>
                        </div>
                    `;
                    return;
                }
                
                // Mostra as informa√ß√µes formatadas
                content.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">${getCountryFlag(data.countryCode)}</div>
                            <h3 style="margin: 0; color: #667eea;">${data.city}, ${data.regionName}</h3>
                            <p style="margin: 5px 0; color: #666;">${data.country}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üìç IP</div>
                            <div style="font-family: monospace; font-size: 1.1rem;">${data.query}</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üèôÔ∏è Cidade</div>
                            <div>${data.city || 'N/A'}</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üó∫Ô∏è Estado/Regi√£o</div>
                            <div>${data.regionName} (${data.region})</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üåê Pa√≠s</div>
                            <div>${data.country} (${data.countryCode})</div>
                        </div>
                        
                        ${data.zip ? `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üìÆ CEP</div>
                            <div>${data.zip}</div>
                        </div>
                        ` : ''}
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üïê Fuso Hor√°rio</div>
                            <div>${data.timezone}</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üåê Provedor (ISP)</div>
                        <div style="margin-bottom: 5px;"><strong>${data.isp}</strong></div>
                        ${data.org ? `<div style="color: #666; font-size: 0.9rem;">${data.org}</div>` : ''}
                        ${data.as ? `<div style="color: #666; font-size: 0.85rem; margin-top: 5px;">${data.as}</div>` : ''}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 10px;">üìå Coordenadas Geogr√°ficas</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <span style="color: #666;">Latitude:</span> <strong>${data.lat}</strong>
                            </div>
                            <div>
                                <span style="color: #666;">Longitude:</span> <strong>${data.lon}</strong>
                            </div>
                        </div>
                        <a href="https://www.google.com/maps?q=${data.lat},${data.lon}" target="_blank" 
                           style="display: inline-block; background: #667eea; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; margin-top: 5px;">
                            üó∫Ô∏è Ver no Google Maps
                        </a>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao buscar localiza√ß√£o:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; color: #d9534f;">‚ùå</div>
                        <p style="color: #d9534f;"><strong>Erro ao buscar localiza√ß√£o</strong></p>
                        <p>N√£o foi poss√≠vel conectar ao servi√ßo de geolocaliza√ß√£o.</p>
                    </div>
                `;
            }
        }

        function getCountryFlag(countryCode) {
            const flags = {
                'BR': 'üáßüá∑', 'US': 'üá∫üá∏', 'PT': 'üáµüáπ', 'ES': 'üá™üá∏', 
                'AR': 'üá¶üá∑', 'CL': 'üá®üá±', 'MX': 'üá≤üáΩ', 'CO': 'üá®üá¥',
                'PE': 'üáµüá™', 'VE': 'üáªüá™', 'UY': 'üá∫üáæ', 'PY': 'üáµüáæ',
                'BO': 'üáßüá¥', 'EC': 'üá™üá®', 'GT': 'üá¨üáπ', 'CU': 'üá®üá∫',
                'DO': 'üá©üá¥', 'HN': 'üá≠üá≥', 'NI': 'üá≥üáÆ', 'SV': 'üá∏üáª',
                'CR': 'üá®üá∑', 'PA': 'üáµüá¶', 'GB': 'üá¨üáß', 'FR': 'üá´üá∑',
                'DE': 'üá©üá™', 'IT': 'üáÆüáπ', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫',
                'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'IN': 'üáÆüá≥', 'RU': 'üá∑üá∫'
            };
            return flags[countryCode] || 'üåç';
        }

        function closeIpLocationModal() {
            document.getElementById('ipLocationModal').style.display = 'none';
        }

        async function viewLoginHistory(nick) {
            try {
                const resp = await fetch(`${API_BASE_URL}/api/get_login_history?nick=${encodeURIComponent(nick)}&limit=50`);
                const data = await resp.json();
                if (!data.success) return alert('Erro ao carregar hist√≥rico');

                const modal = document.getElementById('playerModal');
                const title = document.getElementById('playerModalTitle');
                const content = document.getElementById('playerModalContent');

                title.textContent = `Hist√≥rico de Logins: ${nick}`;
                if (!data.logs || data.logs.length === 0) {
                    content.innerHTML = '<div class="no-data">Nenhum registro encontrado</div>';
                } else {
                    content.innerHTML = data.logs.map(l => `
                        <div class="log-item">
                            <div class="log-header"><strong>${new Date(l.login_time).toLocaleString('pt-BR')}</strong> - Sala: ${l.room_name || '-'} </div>
                            <div style="font-family: monospace; margin-top:6px;">Auth: ${l.auth}</div>
                            <div style="font-family: monospace;">
                                IPv4: ${l.ipv4} 
                                <button class="btn btn-sm" onclick="copyIpv4('${l.ipv4}')" style="margin-left: 8px;">üìã</button>
                                <button class="btn btn-sm" onclick="viewIpLocation('${l.ipv4}')" style="margin-left: 4px;">üåç Ver Local</button>
                            </div>
                            <div style="font-family: monospace;">Conn: ${l.conn}</div>
                        </div>
                    `).join('');

                    if (data.suspicious && data.suspicious.length) {
                        content.innerHTML += `<div style="margin-top:12px; color:#d9534f;"><strong>Aten√ß√£o:</strong> Foram detectadas mudan√ßas suspeitas entre logins.</div>`;
                    }
                }

                modal.style.display = 'block';
            } catch (error) {
                console.error('Erro ao buscar hist√≥rico de login:', error);
                alert('‚ùå Erro ao buscar hist√≥rico');
            }
        }

        // NOVO: Visualizar hist√≥rico de nomes/nicks do jogador
        async function viewNickHistory(nick) {
            try {
                const resp = await fetch(`${API_BASE_URL}/api/get_nick_history?haxball_nick=${encodeURIComponent(nick)}`);
                const data = await resp.json();
                
                if (!data.success) {
                    alert('Erro ao carregar hist√≥rico de nomes: ' + (data.message || 'Erro desconhecido'));
                    return;
                }

                const modal = document.getElementById('playerModal');
                const title = document.getElementById('playerModalTitle');
                const content = document.getElementById('playerModalContent');

                title.textContent = `üìù Hist√≥rico de Nomes`;
                
                if (!data.nicks || data.nicks.length === 0) {
                    content.innerHTML = '<div class="no-data">Nenhum hist√≥rico encontrado</div>';
                } else {
                    let html = `
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #667eea;">
                                <strong>Discord ID:</strong> <code>${data.discord_id}</code><br>
                                <strong>Total de nomes usados:</strong> ${data.total_nicks}
                            </p>
                        </div>
                    `;

                    if (data.nicks.length > 1) {
                        html += `
                            <div class="card" style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; margin-bottom: 15px;">
                                <p style="margin: 0; color: #856404;">
                                    ‚ö†Ô∏è Este jogador j√° usou <strong>${data.nicks.length} nomes diferentes</strong>
                                </p>
                            </div>
                        `;
                    }

                    data.nicks.forEach((nickData, index) => {
                        const isCurrentNick = nickData.nick === nick;
                        const lastUsed = nickData.last_login || nickData.last_update || nickData.registered_at;
                        
                        html += `
                            <div class="log-item" style="${isCurrentNick ? 'border-left: 4px solid #28a745; background: rgba(40, 167, 69, 0.05);' : ''}">
                                <div class="log-header">
                                    <strong style="color: ${isCurrentNick ? '#28a745' : '#667eea'}; font-size: 1.1rem;">
                                        ${isCurrentNick ? '‚úÖ ' : ''}${nickData.nick}${isCurrentNick ? ' (ATUAL)' : ''}
                                    </strong>
                                    <span style="color: #999; font-size: 0.85rem;">
                                        ${lastUsed ? new Date(lastUsed).toLocaleString('pt-BR') : 'Data desconhecida'}
                                    </span>
                                </div>
                                <div style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                                    ${nickData.total_logins > 0 ? `
                                        <div>üìä <strong>${nickData.total_logins}</strong> login(s) registrado(s)</div>
                                    ` : ''}
                                    ${nickData.first_login ? `
                                        <div>üïê Primeira vez: ${new Date(nickData.first_login).toLocaleString('pt-BR')}</div>
                                    ` : ''}
                                    ${nickData.last_login ? `
                                        <div>üïê √öltima vez: ${new Date(nickData.last_login).toLocaleString('pt-BR')}</div>
                                    ` : ''}
                                    ${nickData.registered_at ? `
                                        <div>üìù Registrado em: ${new Date(nickData.registered_at).toLocaleString('pt-BR')}</div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });

                    content.innerHTML = html;
                }

                modal.style.display = 'block';
            } catch (error) {
                console.error('Erro ao buscar hist√≥rico de nomes:', error);
                alert('‚ùå Erro ao buscar hist√≥rico de nomes');
            }
        }

        // RASTREAMENTO - Buscar por identifier (auth/ipv4/conn)
        async function searchByIdentifier() {
            const identifier = document.getElementById('trackSearchInput').value.trim();
            const type = document.getElementById('trackSearchType').value || 'auth';
            const container = document.getElementById('searchResults');
            
            if (!identifier) {
                container.innerHTML = `
                    <div class="card" style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107;">
                        <p style="margin: 0; color: #856404;">
                            ‚ö†Ô∏è Digite um identificador para buscar (auth, IPv4 ou conn)
                        </p>
                    </div>
                `;
                return;
            }

            try {
                container.innerHTML = `
                    <div class="card" style="background: rgba(102, 126, 234, 0.1);">
                        <p style="margin: 0; color: #667eea;">
                            üîç Buscando jogadores com ${type.toUpperCase()}: ${identifier.substring(0, 20)}...
                        </p>
                    </div>
                `;

                const resp = await fetch(`${API_BASE_URL}/api/search_by_identifier?identifier=${encodeURIComponent(identifier)}&type=${encodeURIComponent(type)}`);
                const data = await resp.json();

                if (!data.success) {
                    container.innerHTML = `
                        <div class="card" style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545;">
                            <p style="margin: 0; color: #721c24;">
                                ‚ùå Erro na busca: ${data.message || 'Erro desconhecido'}
                            </p>
                        </div>
                    `;
                    return;
                }

                // Mostrar alertas de seguran√ßa
                let html = '';
                if (data.alerts && data.alerts.length) {
                    data.alerts.forEach(alert => {
                        html += `
                            <div class="card" style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 8px 0; color: #721c24;">üö® ALERTA DE SEGURAN√áA</h4>
                                <p style="margin: 0; color: #721c24;">${alert.message}</p>
                                ${alert.accounts ? `<p style="margin: 5px 0 0 0; color: #721c24;"><strong>Contas envolvidas:</strong> ${alert.accounts.join(', ')}</p>` : ''}
                            </div>
                        `;
                    });
                }

                // Mostrar resultados
                const results = data.results || {};
                const nicks = Object.keys(results);
                
                if (nicks.length === 0) {
                    html += `
                        <div class="card" style="background: rgba(108, 117, 125, 0.1); border-left: 4px solid #6c757d;">
                            <p style="margin: 0; color: #495057;">
                                üìù Nenhum jogador encontrado com este ${type.toUpperCase()}
                            </p>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="card" style="background: rgba(40, 167, 69, 0.1); border-left: 4px solid #28a745; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 8px 0; color: #155724;">‚úÖ RESULTADOS ENCONTRADOS</h4>
                            <p style="margin: 0; color: #155724;">
                                Encontrados <strong>${nicks.length} jogador(es)</strong> que usaram este ${type.toUpperCase()}: 
                                <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">${identifier.substring(0, 30)}${identifier.length > 30 ? '...' : ''}</code>
                            </p>
                        </div>
                    `;

                    nicks.forEach((nick, index) => {
                        const entries = results[nick];
                        const firstEntry = entries[0];
                        const totalLogins = entries.length;

                        html += `
                            <div class="card" style="margin-bottom: 15px; border: 1px solid #e9ecef;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="margin: 0; color: #667eea;">üë§ ${nick}</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">
                                            ${totalLogins} login(s) registrado(s) ‚Ä¢ √öltimo: ${new Date(firstEntry.login_time).toLocaleString('pt-BR')}
                                        </p>
                                    </div>
                                    <button class="btn btn-sm" onclick="viewLoginHistory('${nick}')">
                                        üëÅÔ∏è Ver Hist√≥rico Completo
                                    </button>
                                </div>
                                
                                <div style="background: rgba(248, 249, 250, 0.8); padding: 15px; border-radius: 8px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                                        <div>
                                            <strong style="color: #667eea;">üîë Auth:</strong><br>
                                            <code style="font-size: 0.85rem; word-break: break-all;">${firstEntry.auth || 'N/A'}</code>
                                        </div>
                                        <div>
                                            <strong style="color: #667eea;">üåê IPv4:</strong><br>
                                            <code style="font-size: 0.85rem;">${firstEntry.ipv4 || 'N/A'}</code>
                                            ${firstEntry.ipv4 ? `<br><button class="btn btn-sm" onclick="viewIpLocation('${firstEntry.ipv4}')" style="margin-top: 5px;">üåç Ver Localiza√ß√£o</button>` : ''}
                                        </div>
                                        <div>
                                            <strong style="color: #667eea;">üîó Conn:</strong><br>
                                            <code style="font-size: 0.85rem; word-break: break-all;">${firstEntry.conn || 'N/A'}</code>
                                        </div>
                                    </div>
                                    <p style="margin: 0; color: #666; font-size: 0.85rem;">
                                        üéÆ √öltima sala: <strong>${firstEntry.room_name || 'Desconhecida'}</strong>
                                    </p>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('Erro na busca por identificador:', error);
                container.innerHTML = `
                    <div class="card" style="background: rgba(220, 53, 69, 0.1); border-left: 4px solid #dc3545;">
                        <p style="margin: 0; color: #721c24;">
                            ‚ùå Erro de conex√£o: ${error.message || 'Falha ao conectar com o servidor'}
                        </p>
                    </div>
                `;
            }
        }

        // Login com Enter
        document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Busca no rastreamento com Enter
        document.getElementById('trackSearchInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchByIdentifier();
        });
    </script>
</body>
</html>
